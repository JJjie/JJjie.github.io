<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"><title>tomcat_session_leak</title><link rel="stylesheet" type="text/css" href="../css/blogstyle.css"><link rel="stylesheet" type="text/css" href="../css/fonts.css"><link rel="stylesheet" type="text/css" href="../css/fontello/css/fontello.css"><link rel="stylesheet" type="text/css" href="../fonts/font-awesome/css/font-awesome.css"><link rel="shortcut icon" href="http://liu946.github.io/image/favicon.png"></head><body><aside id="sidebar"><nav id="tags"><a id="avatar" href="index.html"></a><ul id="tags__ul"><li id="js-label1" onclick="window.location=&quot;/blog/blog.html&quot;" class="tags__li tags-btn active">全部文章</li><li id="js-label2" class="tags__li tags-btn">思想</li><li id="js-label3" class="tags__li tags-btn">技术</li><li id="js-label4" class="tags__li tags-btn">技巧</li><li id="js-label5" class="tags__li tags-btn">随笔</li><li id="js-label6" class="tags__li tags-btn">竞赛</li></ul><div id="tags__bottom"><a href="mailto:hwj950504@icloud.com" class="tags-btn fontello"><i class="fa fa-envelope"></i></a><a href="rss.xml" class="tags-btn fontello"><i class="fa fa-rss"></i></a></div></nav><div id="posts-list"><form id="search-form" action="./"><a id="mobile-avatar" href="index.html"></a><input id="search-input" type="text" placeholder="Search..." disabled></form><nav id="pl__container"><a href="/blog/beibaowenti.html" class="think pl__all"><span class="pl__circle"></span><span class="pl__title">背包问题</span><span class="pl__date">2016.1.15</span></a><a href="/blog/functional_programming.html" class="think pl__all"><span class="pl__circle"></span><span class="pl__title">函数式编程</span><span class="pl__date">2015.4.5</span></a><a href="/blog/async&amp;sync.html" class="think pl__all"><span class="pl__circle"></span><span class="pl__title">异步与同步</span><span class="pl__date">2015.3.7</span></a><a href="/blog/jquery_selfevent.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">jQuery自定义事件</span><span class="pl__date">2016.1.16</span></a><a href="/blog/concurrent_skill.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">处理并发的一些技巧和思想</span><span class="pl__date">2015.11.27</span></a><a href="/blog/canvas_read.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">使用Canvas进行验证码识别</span><span class="pl__date">2015.10.18</span></a><a href="/blog/php_request.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">php发送请求方法简明总结</span><span class="pl__date">2015.10.18</span></a><a href="/blog/tomcat_session_leak.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">Apache Tomcat样例目录session操纵漏洞</span><span class="pl__date">2015.10.9</span></a><a href="/blog/js_activexobject.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">JavaScript中的ActiveXObject对象</span><span class="pl__date">2015.10.8</span></a><a href="/blog/X_Frame_Options.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">X-Frame-Options 响应头</span><span class="pl__date">2015.10.8</span></a><a href="/blog/jquery_deferredandpromise.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">jQuery Deferred和Promise创建响应式应用程序详细介绍</span><span class="pl__date">2015.10.8</span></a><a href="/blog/sqlmap_use.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">sqlmap用户手册</span><span class="pl__date">2015.10.1</span></a><a href="/blog/js_TopParentIframe.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">js中的top、parent、frame</span><span class="pl__date">2015.10.1</span></a><a href="/blog/node_get_IPaddress.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">node获取客户端IP地址</span><span class="pl__date">2015.10.1</span></a><a href="/blog/css3_matrix.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">理解CSS3 transform中的Matrix</span><span class="pl__date">2015.9.28</span></a><a href="/blog/viewpoint.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">viewpoint和他的朋友们</span><span class="pl__date">2015.6.10</span></a><a href="/blog/submit_File.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">文件提交方式总结</span><span class="pl__date">2015.6.7</span></a><a href="/blog/mysql_of_commands.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">Mysql 命令大全</span><span class="pl__date">2015.5.15</span></a><a href="/blog/mousewheel.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">js中鼠标滚轮事件详解</span><span class="pl__date">2015.5.12</span></a><a href="/blog/mobie_adaption.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">移动端适应与小技巧</span><span class="pl__date">2015.5.10</span></a><a href="/blog/js_preventmodification.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">JS阻止对象的修改</span><span class="pl__date">2015.5.6</span></a><a href="/blog/js_Delegation.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">Javascript事件代理和委托（Delegation）</span><span class="pl__date">2015.5.4</span></a><a href="/blog/jquery_dynamic_load_js.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">使用jQuery动态加载js脚本文件的方法</span><span class="pl__date">2015.5.1</span></a><a href="/blog/javascript_special_skill.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">你可能不知道的javascript奇淫技巧</span><span class="pl__date">2015.4.26</span></a><a href="/blog/javascript_of_new,this,call,apply.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">Javascript技术难点之new,this,call,apply</span><span class="pl__date">2015.4.21</span></a><a href="/blog/javascript_of_map_reduce_filter.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">JavaScript实现Map、Reduce和Filter</span><span class="pl__date">2015.4.20</span></a><a href="/blog/javascript_cross-domain.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">JavaScript跨域总结与解决办法</span><span class="pl__date">2015.4.16</span></a><a href="/blog/ie6_compatiable_10skills.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">解决IE6兼容性问题的十大技巧</span><span class="pl__date">2015.4.15</span></a><a href="/blog/H5_animation_60fps.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">H5动画60fps之路</span><span class="pl__date">2015.4.10</span></a><a href="/blog/es6_new_properties.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">ES6新特性概览</span><span class="pl__date">2015.4.5</span></a><a href="/blog/dom_event_flow.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">JS DOM操作入门</span><span class="pl__date">2015.4.3</span></a><a href="/blog/css_remove_float.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">CSS清除浮动</span><span class="pl__date">2015.3.31</span></a><a href="/blog/css_character.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">网页中嵌入字体的解决方案</span><span class="pl__date">2015.3.26</span></a><a href="/blog/css_center_horizontally.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">CSS水平垂直居中</span><span class="pl__date">2015.3.25</span></a><a href="/blog/css3_pointer-events.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">CSS3之pointer-events属性值详解</span><span class="pl__date">2015.3.21</span></a><a href="/blog/css3_grid.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">CSS3 Grid布局：网格布局让内容优先</span><span class="pl__date">2015.3.18</span></a><a href="/blog/css3_box-display.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">CSS3盒模型display:box详解</span><span class="pl__date">2015.3.15</span></a><a href="/blog/browser_caching.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">浏览器缓存</span><span class="pl__date">2015.3.9</span></a><a href="/blog/browser_compatiable.html" class="tech pl__all"><span class="pl__circle"></span><span class="pl__title">浏览器兼容</span><span class="pl__date">2015.3.9</span></a><a href="/blog/wget.html" class="skill pl__all"><span class="pl__circle"></span><span class="pl__title">wget 递归下载整个网站</span><span class="pl__date">2015.12.13</span></a><a href="/blog/netstat_introduce.html" class="skill pl__all"><span class="pl__circle"></span><span class="pl__title">netstat命令详解</span><span class="pl__date">2015.10.18</span></a><a href="/blog/nc_introduce.html" class="skill pl__all"><span class="pl__circle"></span><span class="pl__title">nc命令详解</span><span class="pl__date">2015.10.18</span></a><a href="/blog/kali_breakwifiwpa.html" class="skill pl__all"><span class="pl__circle"></span><span class="pl__title">利用kali破解wifi密码全过程</span><span class="pl__date">2015.10.8</span></a><a href="/blog/quickly_options.html" class="skill pl__all"><span class="pl__circle"></span><span class="pl__title">快捷操作大全</span><span class="pl__date">2015.6.5</span></a><a href="/blog/python_http,ftp.html" class="skill pl__all"><span class="pl__circle"></span><span class="pl__title">使用python创建简单的HTTP和FTP服务</span><span class="pl__date">2015.5.20</span></a><a href="/blog/os_yosemitemac_mac_change.html" class="skill pl__all"><span class="pl__circle"></span><span class="pl__title">OS X 10.10 Yosemite 修改网卡 Mac 地址的方法</span><span class="pl__date">2015.5.17</span></a><a href="/blog/git_command.html" class="skill pl__all"><span class="pl__circle"></span><span class="pl__title">git命令</span><span class="pl__date">2015.4.7</span></a><a href="/blog/hitcon2015_web100.html" class="exam pl__all"><span class="pl__circle"></span><span class="pl__title">Hitcon2015CTF web100</span><span class="pl__date">2015.10.20</span></a><a href="/blog/hitcon2015_web300.html" class="exam pl__all"><span class="pl__circle"></span><span class="pl__title">Hitcon2015CTF web300</span><span class="pl__date">2015.10.20</span></a><a href="/blog/xdctf2015_web2.html" class="exam pl__all"><span class="pl__circle"></span><span class="pl__title">XDctf2015 web2</span><span class="pl__date">2015.10.8</span></a></nav></div></aside><div id="post"><div id="pjax"><div id="post__content" style="font-size: 100%;"><article><h1>Apache Tomcat样例目录session操纵漏洞</h1>

<h3>背景</h3>

<p>前段时间扫到的漏洞，研究了下，感觉挺有意思的，发出来和大家分享下，有啥不对的地方还请各位拍砖指正。</p>

<p>Apache Tomcat默认安装包含”/examples”目录，里面存着众多的样例，其中session样例(/examples/servlets /servlet/SessionExample)允许用户对session进行操纵。因为session是全局通用的，所以用户可以通过操纵 session获取管理员权限。</p>

<p>案例:http://www.wooyun.org/bugs/wooyun-2014-064812</p>

<h3>漏洞分析</h3>

<p>首先，我们先来看看SessionExample的部分源码</p>

<pre><code>//表单代码
out.println(&quot;&lt;P&gt;&quot;);
out.print(&quot;&lt;form action=\&quot;&quot;);
out.print(response.encodeURL(&quot;SessionExample&quot;));
out.print(&quot;\&quot; &quot;);
out.println(&quot;method=POST&gt;&quot;);
out.println(rb.getString(&quot;sessions.dataname&quot;));
out.println(&quot;&lt;input type=text size=20 name=dataname&gt;&quot;);
out.println(&quot;&lt;br&gt;&quot;);
out.println(rb.getString(&quot;sessions.datavalue&quot;));
out.println(&quot;&lt;input type=text size=20 name=datavalue&gt;&quot;);
out.println(&quot;&lt;br&gt;&quot;);
out.println(&quot;&lt;input type=submit&gt;&quot;);
out.println(&quot;&lt;/form&gt;&quot;);

//核心代码
HttpSession session = request.getSession(true);
out.println(rb.getString(&quot;sessions.id&quot;) + &quot; &quot; +
session.getId());
out.println(&quot;&lt;br&gt;&quot;);
out.println(rb.getString(&quot;sessions.created&quot;) + &quot; &quot;);
out.println(new Date(session.getCreationTime()) +
&quot;&lt;br&gt;&quot;);
out.println(rb.getString(&quot;sessions.lastaccessed&quot;) + &quot;
&quot;);
out.println(new Date(session.getLastAccessedTime()));
String dataName = request.getParameter(&quot;dataname&quot;);//获取dataname参数的值
String dataValue = request.getParameter(&quot;datavalue&quot;);//获取datavalue参数的值
if (dataName != null &amp;&amp; dataValue != null) {
session.setAttribute(dataName, dataValue);//将dataname和datavalue写入session
}</code></pre>

<p>用户通过表单提交dataname和datavalue参数，然后通过request.getParameter（）函数获取这两个参数的值，再通过 session.setAttribute()函数将dataname和datavalue的值写入session。</p>

<p>因为session全局通用的特性， 所以可以通过操纵session参数的值来获取网站管理员权限的目的。</p>

<p>举个例子：</p>

<p>我们先来编写login.jsp,login2.jsp,index.jsp这三个页面，通过这三个页面来模拟一般网站身份验证的过程。</p>

<p>login.jsp</p>

<pre><code>&lt;form
action=login2.jsp method=&quot;POST&quot; &gt;
用户名: &lt;input type=&quot;text&quot;
name=&quot;username&quot;&gt;&lt;br&gt;
密码: &lt;input type=&quot;text&quot; name=&quot;password&quot;
&gt;&lt;br&gt;
&lt;input
type=&quot;submit&quot; value=&quot;登录&quot;&gt;&lt;br&gt;
&lt;form&gt;</code></pre>

<p>login2.jsp</p>

<pre><code>&lt;%
if
(request.getParameter(&quot;username&quot;) != null &amp;&amp;
request.getParameter(&quot;password&quot;)
!= null) {
String username =
request.getParameter(&quot;username&quot;);
String password =
request.getParameter(&quot;password&quot;);
//验证身份
if (username.equals(&quot;admin&quot;)
&amp;&amp; password.equals(&quot;admin&quot;)) {
session.setAttribute(&quot;login&quot;,
&quot;admin&quot;);
response.sendRedirect(&quot;index.jsp&quot;);
}
else {
response.sendRedirect(&quot;login.jsp&quot;);
}  
}
%&gt;</code></pre>

<p>index.jsp</p>

<pre><code>&lt;%
if(session.getAttribute(&quot;login&quot;)
!= null &amp;&amp;
((String)session.getAttribute(&quot;login&quot;)).equals(&quot;admin&quot;))
{
out.println(&quot;Login&quot;);
} else{
response.sendRedirect(&quot;login.jsp&quot;);
}
%&gt;</code></pre>

<p>我们直接打开网站后台，即index.jsp</p>

<p>http://127.0.0.1:8080/examples/index.jsp</p>

<p><img alt="" src="http://www.moonsec.com/content/uploadfile/201506/35d18da3ded8438e6ccd97635907e91320150606051951.png"/></p>

<p>发现被重定向到login.jsp了，而且在不知道密码的前提下，我们是无法登陆进去的。接下将演示如何通过操纵session进入网站后台</p>

<p>打开SessionExample</p>

<p>http://127.0.0.1:8080/examples/servlets/servlet/SessionExample</p>

<p>在Name of Session Attribute: 里输入login</p>

<p>在Value of Session Attribute:里输入admin</p>

<p><img alt="" src="http://www.moonsec.com/content/uploadfile/201506/aebf36291a7dd50e5bd3db8ce56d6c8d20150606051951.png"/></p>

<p>提交后显示login=admin已经写入session</p>

<p><img alt="" src="http://www.moonsec.com/content/uploadfile/201506/adb78857c37c499ade45ed403ddd32c720150606051952.png"/></p>

<p>再次打开index.jsp，显示成功登录</p>

<p><img alt="" src="http://www.moonsec.com/content/uploadfile/201506/d7a41477e0580431157de038a154560820150606051952.png"/></p>

<h3>修复建议</h3>

<p>删</p>

<h3>题外话</h3>

<p>不觉得这个挺适合做后门的吗？</p>

<pre><code>&lt;%setAttribute(&quot;request.getParameter(&quot;u&quot;)&quot;, &quot; request.getParameter(&quot;a&quot;)%&gt;</code></pre>

<p>“u”和”a”的值看后台源码</p></article></div><div class="index"><div id="post__share"><a id="icon-qq" href="http://user.qzone.qq.com/1476837906" target="_blank" class="fontello"><i class="fa fa-qq"></i></a><a id="icon-github" href="https://github.com/JJjie" target="_blank" class="fontello"><i class="fa fa-github"></i></a><a id="icon-weibo" href="http://www.weibo.com/3836806618/profile?topnav=1&amp;wvr=6" target="_blank" class="fontello"><i class="fa fa-weibo"></i></a></div><p id="copyright" style="border-top: 2px solid rgba(229, 232, 236, 0);">Author<a href="index.html" target="_blank">Hankin Jie</a></p></div></div></div><button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button><script src="../js/jquery.1.11.1.js"></script><script src="../js/jquery.pjax.js"></script><script src="../js/nprogress.js"></script><script src="../js/script.js"></script><script tupe="text/javascript">function getPar(par){
    //获取当前URL
    var local_url = document.location.href;
    //获取要取得的get参数位置
    var get = local_url.indexOf(par +"=");
    if(get == -1){
        return false;
    }
    //截取字符串
    var get_par = local_url.slice(par.length + get + 1);
    //判断截取后的字符串是否还有其他get参数
    var nextPar = get_par.indexOf("&");
    if(nextPar != -1){
        get_par = get_par.slice(0, nextPar);
    }
        return get_par;
}
if(getPar('show')=='full')
{
    document.getElementById('pjax').setAttribute('class','fullscreen');
    sidebar=document.getElementById('sidebar');
    sidebar.style.display='none';
    sidebar.setAttribute('class','fullscreen');
}</script></body></html>